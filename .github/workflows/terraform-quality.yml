name: "Terraform Quality"

on:
  workflow_dispatch:
    inputs:
      terraform_version:
        type: string
        default: "1.9.8"
      tflint_version:
        type: string
        default: "v0.53.0"
      working_directory:
        type: string
        default: "."
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

env:
  COMMENT_IDENTIFIER: "Terraform Quality Checks"

jobs:
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    outputs:
      fmt_outcome: ${{ steps.fmt.outcome }}
      validate_outcome: ${{ steps.validate.outcome }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_version: ${{ inputs.terraform_version }}

      - name: Format Check
        id: fmt
        working-directory: ${{ inputs.working_directory }}
        run: terraform fmt -check -recursive -diff -no-color

      - name: Initialize
        working-directory: ${{ inputs.working_directory }}
        run: terraform init -backend=false -input=false -no-color

      - name: Validate
        id: validate
        working-directory: ${{ inputs.working_directory }}
        run: terraform validate -no-color

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@4cb9feea73331a35b422df102992a03a44a3bb33 # v6.2.1
        with:
          tflint_version: ${{ inputs.tflint_version }}

      - name: TFLint Init
        run: tflint --init
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: TFLint Run
        id: lint
        working-directory: ${{ inputs.working_directory }}
        run: tflint --recursive --format=compact --no-color
        continue-on-error: true

      - name: Comment Quality Results on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const commentIdentifier = process.env.COMMENT_IDENTIFIER;
            const body = `### ${commentIdentifier}

            | Check | Result | Status |
            |-------|--------|--------|
            | Format | \`${{ steps.fmt.outcome }}\` | ${{ steps.fmt.outcome == 'success' && '✅' || '❌' }} |
            | Validate | \`${{ steps.validate.outcome }}\` | ${{ steps.validate.outcome == 'success' && '✅' || '❌' }} |
            | Lint | \`${{ steps.lint.outcome }}\` | ${{ steps.lint.outcome == 'success' && '✅' || '⚠️' }} |

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes(commentIdentifier)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }
